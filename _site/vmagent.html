<!DOCTYPE html> <html lang="en" dir="auto"> <head><meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=no"> <meta name="description" content="vmagent vmagent is a tiny but brave agent, which helps you collect metrics from various sources and stores them in VictoriaMetrics or any other Pro..."> <meta name="revised" content="156072bda364bc719a657b8c14a5f5ba4c757132"> <meta name="author" content="Brensted"> <meta name="generator" content="rundocs/jekyll-rtd-theme v2.0.10"><meta name="theme-color" content="#2980b9"> <title>vmagent 路 VictoriaMetrics</title> <meta name="twitter:title" content="vmagent 路 VictoriaMetrics"> <meta name="twitter:description" content="vmagent vmagent is a tiny but brave agent, which helps you collect metrics from various sources and stores them in VictoriaMetrics or any other Pro..."> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@Brensted"> <meta name="twitter:url" content="http://localhost:4000/vmagent.html"> <meta name="twitter:creator" content="@rundocs/jekyll-rtd-theme v2.0.10"> <meta property="og:title" content="vmagent 路 VictoriaMetrics"> <meta property="og:description" content="vmagent vmagent is a tiny but brave agent, which helps you collect metrics from various sources and stores them in VictoriaMetrics or any other Pro..."> <meta property="og:locale" content="en"> <meta property="og:url" content="http://localhost:4000/vmagent.html"> <meta property="og:type" content="article"> <meta property="article:author" content="Brensted"> <meta property="article:published_time" content="2021-02-25T10:08:59+02:00"> <meta property="article:modified_time" content="2021-02-25T10:28:47+02:00"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Article", "mainEntityOfPage": { "@type": "WebPage", "@id": "http://localhost:4000/vmagent.html" }, "headline": "vmagent 路 VictoriaMetrics", "image": [], "author": { "@type": "Person", "name": "Brensted" }, "datePublished": "2021-02-25T10:08:59+02:00", "dateModified": "2021-02-25T10:28:47+02:00", "publisher": { "@type": "User", "name": "Brensted", "logo": { "@type": "ImageObject", "url": "https://avatars.githubusercontent.com/u/75306281?v=4" } }, "description": "vmagent vmagent is a tiny but brave agent, which helps you collect metrics from various sources and stores them in VictoriaMetrics or any other Pro..." } </script> <link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="prev" href="http://localhost:4000/Single-server-VictoriaMetrics.html"><link rel="next" href="http://localhost:4000/vmalert.html"><link rel="canonical" href="http://localhost:4000/vmagent.html"><link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg"><link rel="icon" type="image/png" href="/assets/images/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/assets/images/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/assets/images/favicon-96x96.png" sizes="96x96"><link rel="mask-icon" href="/assets/images/favicon.svg" color="#2980b9"><link rel="apple-touch-icon" href="/assets/images/apple-touch-icon-300x300.jpg"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/css/theme.min.css"><script> window.ui = { title: "VictoriaMetrics", baseurl: "", i18n: { search_results: "Search Results", search_results_found: "Search finished, found # page(s) matching the search query.", search_results_not_found: "Your search did not match any documents, please make sure that all characters are spelled correctly!" } }; </script> </head> <body class="container"><div class="sidebar-wrap overflow-hidden"> <div class="sidebar height-full overflow-y-scroll overflow-x-hidden"> <div class="header d-flex flex-column p-3 text-center"> <div class="title pb-1"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/" title="VictoriaMetrics"> <i class="fa fa-home"></i> VictoriaMetrics </a> </div> <span class="version"></span> <form class="search pt-2" action="/search.html" method="get" autocomplete="off"> <input class="form-control input-block input-sm" type="text" name="q" placeholder="Search docs..."> </form> </div> <div class="toctree py-2" data-spy="affix" role="navigation" aria-label="main navigation"> <ul> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/Cluster-VictoriaMetrics.html">Cluster version</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/ExtendedPromQL.html">MetricsQL</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/Home.html">Docs</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/Quick-Start.html">Quick Start</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/Release-Guide.html">Release-Guide.md</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/SampleSizeCalculations.html">Sample size calculations</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/Single-server-VictoriaMetrics.html">Single-server-VictoriaMetrics.md</a> </li> <li class="toc level-1 current" data-sort="" data-level="1"> <a class="d-flex flex-items-baseline current" href="/vmagent.html">vmagent</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/vmalert.html">vmalert</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/vmauth.html">vmauth</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/vmbackup.html">vmbackup</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/vmctl.html">vmctl</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/vmrestore.html">vmrestore</a> </li> </ul> </div> </div> </div> <div class="content-wrap"> <div class="header d-flex flex-justify-between p-2 hide-lg hide-xl" aria-label="top navigation"> <button id="toggle" aria-label="Toggle menu" class="btn-octicon p-2 m-0 text-white" type="button"> <i class="fa fa-bars"></i> </button> <div class="title flex-1 d-flex flex-justify-center"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/">VictoriaMetrics</a> </div> </div> <div class="content p-3 p-sm-5"> <div class="navigation-top d-flex flex-justify-between"> <ul class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation"> <li class="breadcrumb-item"> <a class="no-underline" href="/" title="/"> <i class="fa fa-home"></i> </a> </li><li class="breadcrumb-item" aria-current="page">vmagent.md</li></ul> <a class="edit" href="https://github.com/Brensted/test1/edit/gh-pages/vmagent.md" title="Edit on GitHub" rel="noreferrer" target="_blank"> <i class="fa fa-edit"></i> </a> </div> <hr> <div role="main" itemscope="itemscope" itemtype="https://schema.org/Article"> <div class="markdown-body" itemprop="articleBody"> <h2 id="vmagent">vmagent</h2> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> is a tiny but brave agent, which helps you collect metrics from various sources and stores them in <a href="https://github.com/VictoriaMetrics/VictoriaMetrics">VictoriaMetrics</a> or any other Prometheus-compatible storage system that supports the <code class="language-plaintext highlighter-rouge notranslate">remote_write</code> protocol.</p> <p><img alt="vmagent" src="vmagent.png" /></p> <h2 id="motivation">Motivation</h2> <p>While VictoriaMetrics provides an efficient solution to store and observe metrics, our users needed something fast and RAM friendly to scrape metrics from Prometheus-compatible exporters to VictoriaMetrics. Also, we found that users' infrastructure are snowflakes - no two are alike, and we decided to add more flexibility to <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> (like the ability to push metrics instead of pulling them). We did our best and plan to do even more.</p> <h2 id="features">Features</h2> <ul> <li>Can be used as drop-in replacement for Prometheus for scraping targets such as <a href="https://github.com/prometheus/node_exporter">node_exporter</a>. See <a href="#quick-start">Quick Start</a> for details.</li> <li>Can add, remove and modify labels (aka tags) via Prometheus relabeling. Can filter data before sending it to remote storage. See <a href="#relabeling">these docs</a> for details.</li> <li>Accepts data via all the ingestion protocols supported by VictoriaMetrics: <ul> <li>Influx line protocol via <code class="language-plaintext highlighter-rouge notranslate">http://&lt;vmagent&gt;:8429/write</code>. See <a href="https://victoriametrics.github.io/Single-server-VictoriaMetrics.html#how-to-send-data-from-influxdb-compatible-agents-such-as-telegraf">these docs</a>.</li> <li>Graphite plaintext protocol if <code class="language-plaintext highlighter-rouge notranslate">-graphiteListenAddr</code> command-line flag is set. See <a href="https://victoriametrics.github.io/Single-server-VictoriaMetrics.html#how-to-send-data-from-graphite-compatible-agents-such-as-statsd">these docs</a>.</li> <li>OpenTSDB telnet and http protocols if <code class="language-plaintext highlighter-rouge notranslate">-opentsdbListenAddr</code> command-line flag is set. See <a href="https://victoriametrics.github.io/Single-server-VictoriaMetrics.html#how-to-send-data-from-opentsdb-compatible-agents">these docs</a>.</li> <li>Prometheus remote write protocol via <code class="language-plaintext highlighter-rouge notranslate">http://&lt;vmagent&gt;:8429/api/v1/write</code>.</li> <li>JSON lines import protocol via <code class="language-plaintext highlighter-rouge notranslate">http://&lt;vmagent&gt;:8429/api/v1/import</code>. See <a href="https://victoriametrics.github.io/Single-server-VictoriaMetrics.html#how-to-import-data-in-json-line-format">these docs</a>.</li> <li>Native data import protocol via <code class="language-plaintext highlighter-rouge notranslate">http://&lt;vmagent&gt;:8429/api/v1/import/native</code>. See <a href="https://victoriametrics.github.io/Single-server-VictoriaMetrics.html#how-to-import-data-in-native-format">these docs</a>.</li> <li>Data in Prometheus exposition format. See <a href="https://victoriametrics.github.io/Single-server-VictoriaMetrics.html#how-to-import-data-in-prometheus-exposition-format">these docs</a> for details.</li> <li>Arbitrary CSV data via <code class="language-plaintext highlighter-rouge notranslate">http://&lt;vmagent&gt;:8429/api/v1/import/csv</code>. See <a href="https://victoriametrics.github.io/Single-server-VictoriaMetrics.html#how-to-import-csv-data">these docs</a>.</li> </ul> </li> <li>Can replicate collected metrics simultaneously to multiple remote storage systems.</li> <li>Works in environments with unstable connections to remote storage. If the remote storage is unavailable, the collected metrics are buffered at <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.tmpDataPath</code>. The buffered metrics are sent to remote storage as soon as connection to remote storage is recovered. The maximum disk usage for the buffer can be limited with <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.maxDiskUsagePerURL</code>.</li> <li>Uses lower amounts of RAM, CPU, disk IO and network bandwidth compared to Prometheus.</li> </ul> <h2 id="quick-start">Quick Start</h2> <p>Just download <code class="language-plaintext highlighter-rouge notranslate">vmutils-*</code> archive from <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/releases">releases page</a>, unpack it and pass the following flags to <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> binary in order to start scraping Prometheus targets:</p> <ul> <li><code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code> with the path to Prometheus config file (it is usually located at <code class="language-plaintext highlighter-rouge notranslate">/etc/prometheus/prometheus.yml</code>)</li> <li><code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code> with the remote storage endpoint such as VictoriaMetrics. The <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code> argument can be specified multiple times in order to replicate data concurrently to an arbitrary number of remote storage systems.</li> </ul> <p>Example command line:</p> <div class="language-plaintext highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>/path/to/vmagent -promscrape.config=/path/to/prometheus.yml -remoteWrite.url=https://victoria-metrics-host:8428/api/v1/write
</code></pre>  </div></div> <p>If you only need to collect Influx data, then the following is sufficient:</p> <div class="language-plaintext highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>/path/to/vmagent -remoteWrite.url=https://victoria-metrics-host:8428/api/v1/write
</code></pre>  </div></div> <p>Then send Influx data to <code class="language-plaintext highlighter-rouge notranslate">http://vmagent-host:8429</code>. See <a href="https://victoriametrics.github.io/Single-server-VictoriaMetrics.html#how-to-send-data-from-influxdb-compatible-agents-such-as-telegraf">these docs</a> for more details.</p> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> is also available in <a href="https://hub.docker.com/r/victoriametrics/vmagent/tags">docker images</a>.</p> <p>Pass <code class="language-plaintext highlighter-rouge notranslate">-help</code> to <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> in order to see the full list of supported command-line flags with their descriptions.</p> <h2 id="configuration-update">Configuration update</h2> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> should be restarted in order to update config options set via command-line args.</p> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> supports multiple approaches for reloading configs from updated config files such as <code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code>, <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.relabelConfig</code> and <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.urlRelabelConfig</code>:</p> <ul> <li>Sending <code class="language-plaintext highlighter-rouge notranslate">SUGHUP</code> signal to <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> process: <div class="language-bash highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="nb">kill</span> <span class="nt">-SIGHUP</span> <span class="sb">`</span>pidof vmagent<span class="sb">`</span>
</code></pre>  </div> </div> </li> <li>Sending HTTP request to <code class="language-plaintext highlighter-rouge notranslate">http://vmagent:8429/-/reload</code> endpoint.</li> </ul> <p>There is also <code class="language-plaintext highlighter-rouge notranslate">-promscrape.configCheckInterval</code> command-line option, which can be used for automatic reloading configs from updated <code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code> file.</p> <h2 id="use-cases">Use cases</h2> <h3 id="iot-and-edge-monitoring">IoT and Edge monitoring</h3> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> can run and collect metrics in IoT and industrial networks with unreliable or scheduled connections to the remote storage. It buffers the collected data in local files until the connection to remote storage becomes available and then sends the buffered data to the remote storage. It re-tries sending the data to remote storage on any errors. The maximum buffer size can be limited with <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.maxDiskUsagePerURL</code>.</p> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> works on various architectures from IoT world - 32-bit arm, 64-bit arm, ppc64, 386, amd64. See <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/master/app/vmagent/Makefile">the corresponding Makefile rules</a> for details.</p> <h3 id="drop-in-replacement-for-prometheus">Drop-in replacement for Prometheus</h3> <p>If you use Prometheus only for scraping metrics from various targets and forwarding these metrics to remote storage, then <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> can replace such Prometheus setup. Usually <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> requires lower amounts of RAM, CPU and network bandwidth comparing to Prometheus for such a setup. See <a href="#how-to-collect-metrics-in-prometheus-format">these docs</a> for details.</p> <h3 id="replication-and-high-availability">Replication and high availability</h3> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> replicates the collected metrics among multiple remote storage instances configured via <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code> args. If a single remote storage instance temporarily is out of service, then the collected data remains available in another remote storage instances. <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> buffers the collected data in files at <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.tmpDataPath</code> until the remote storage becomes available again. Then it sends the buffered data to the remote storage in order to prevent data gaps in the remote storage.</p> <h3 id="relabeling-and-filtering">Relabeling and filtering</h3> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> can add, remove or update labels on the collected data before sending it to remote storage. Additionally, it can remove unwanted samples via Prometheus-like relabeling before sending the collected data to remote storage. See <a href="#relabeling">these docs</a> for details.</p> <h3 id="splitting-data-streams-among-multiple-systems">Splitting data streams among multiple systems</h3> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> supports splitting the collected data between muliple destinations with the help of <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.urlRelabelConfig</code>, which is applied independently for each configured <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code> destination. For instance, it is possible to replicate or split data among long-term remote storage, short-term remote storage and real-time analytical system <a href="https://github.com/Telefonica/prometheus-kafka-adapter">built on top of Kafka</a>. Note that each destination can receive its own subset of the collected data thanks to per-destination relabeling via <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.urlRelabelConfig</code>.</p> <h3 id="prometheus-remote_write-proxy">Prometheus remote_write proxy</h3> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> may be used as a proxy for Prometheus data sent via Prometheus <code class="language-plaintext highlighter-rouge notranslate">remote_write</code> protocol. It can accept data via <code class="language-plaintext highlighter-rouge notranslate">remote_write</code> API at <code class="language-plaintext highlighter-rouge notranslate">/api/v1/write</code> endpoint, apply relabeling and filtering and then proxy it to another <code class="language-plaintext highlighter-rouge notranslate">remote_write</code> systems. The <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> can be configured to encrypt the incoming <code class="language-plaintext highlighter-rouge notranslate">remote_write</code> requests with <code class="language-plaintext highlighter-rouge notranslate">-tls*</code> command-line flags. Additionally, Basic Auth can be enabled for the incoming <code class="language-plaintext highlighter-rouge notranslate">remote_write</code> requests with <code class="language-plaintext highlighter-rouge notranslate">-httpAuth.*</code> command-line flags.</p> <h3 id="remote_write-for-clustered-version">remote_write for clustered version</h3> <p>Despite <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> can accept data in several supported protocols (OpenTSDB, Influx, Prometheus, Graphite) and scrape data from various targets, writes always peformed in Promethes remote_write protocol. Therefore for clustered version <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code> command-line flag should be configured as <code class="language-plaintext highlighter-rouge notranslate">&lt;schema&gt;://&lt;vminsert-host&gt;:8480/insert/&lt;customer-id&gt;/prometheus/api/v1/write</code></p> <h2 id="how-to-collect-metrics-in-prometheus-format">How to collect metrics in Prometheus format</h2> <p>Pass the path to <code class="language-plaintext highlighter-rouge notranslate">prometheus.yml</code> to <code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code> command-line flag. <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> takes into account the following sections from <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">Prometheus config file</a>:</p> <ul> <li><code class="language-plaintext highlighter-rouge notranslate">global</code></li> <li><code class="language-plaintext highlighter-rouge notranslate">scrape_configs</code></li> </ul> <p>All the other sections are ignored, including <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#remote_write">remote_write</a> section. Use <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.*</code> command-line flags instead for configuring remote write settings.</p> <p>The following scrape types in <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config">scrape_config</a> section are supported:</p> <ul> <li><code class="language-plaintext highlighter-rouge notranslate">static_configs</code> - for scraping statically defined targets. See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#static_config">these docs</a> for details.</li> <li><code class="language-plaintext highlighter-rouge notranslate">file_sd_configs</code> - for scraping targets defined in external files aka file-based service discover. See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config">these docs</a> for details.</li> <li><code class="language-plaintext highlighter-rouge notranslate">kubernetes_sd_configs</code> - for scraping targets in Kubernetes (k8s). See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config">kubernetes_sd_config</a> for details.</li> <li><code class="language-plaintext highlighter-rouge notranslate">ec2_sd_configs</code> - for scraping targets in Amazon EC2. See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#ec2_sd_config">ec2_sd_config</a> for details. <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> doesn't support <code class="language-plaintext highlighter-rouge notranslate">profile</code> config param and aws credentials file yet.</li> <li><code class="language-plaintext highlighter-rouge notranslate">gce_sd_configs</code> - for scraping targets in Google Compute Engine (GCE). See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#gce_sd_config">gce_sd_config</a> for details. <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> provides the following additional functionality for <code class="language-plaintext highlighter-rouge notranslate">gce_sd_config</code>: <ul> <li>if <code class="language-plaintext highlighter-rouge notranslate">project</code> arg is missing, then <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> uses the project for the instance where it runs;</li> <li>if <code class="language-plaintext highlighter-rouge notranslate">zone</code> arg is missing, then <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> uses the zone for the instance where it runs;</li> <li>if <code class="language-plaintext highlighter-rouge notranslate">zone</code> arg equals to <code class="language-plaintext highlighter-rouge notranslate">"*"</code>, then <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> discovers all the zones for the given project;</li> <li><code class="language-plaintext highlighter-rouge notranslate">zone</code> may contain arbitrary number of zones, i.e. <code class="language-plaintext highlighter-rouge notranslate">zone: [us-east1-a, us-east1-b]</code>.</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge notranslate">consul_sd_configs</code> - for scraping targets registered in Consul. See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#consul_sd_config">consul_sd_config</a> for details.</li> <li><code class="language-plaintext highlighter-rouge notranslate">dns_sd_configs</code> - for scraping targets discovered from DNS records (SRV, A and AAAA). See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dns_sd_config">dns_sd_config</a> for details.</li> <li><code class="language-plaintext highlighter-rouge notranslate">openstack_sd_configs</code> - for scraping OpenStack targets. See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#openstack_sd_config">openstack_sd_config</a> for details. <a href="https://docs.openstack.org/api-ref/identity/v3/">OpenStack identity API v3</a> is supported only.</li> <li><code class="language-plaintext highlighter-rouge notranslate">dockerswarm_sd_configs</code> - for scraping Docker Swarm targets. See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dockerswarm_sd_config">dockerswarm_sd_config</a> for details.</li> <li><code class="language-plaintext highlighter-rouge notranslate">eureka_sd_configs</code> - for scraping targets registered in <a href="https://github.com/Netflix/eureka">Netflix Eureka</a>. See <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#eureka_sd_config">eureka_sd_config</a> for details.</li> </ul> <p>File feature requests at <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/issues">our issue tracker</a> if you need other service discovery mechanisms to be supported by <code class="language-plaintext highlighter-rouge notranslate">vmagent</code>.</p> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> also support the following additional options in <code class="language-plaintext highlighter-rouge notranslate">scrape_config</code> section:</p> <ul> <li><code class="language-plaintext highlighter-rouge notranslate">disable_compression: true</code> - for disabling response compression on a per-job basis. By default <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> requests compressed responses from scrape targets in order to save network bandwidth.</li> <li><code class="language-plaintext highlighter-rouge notranslate">disable_keepalive: true</code> - for disabling <a href="https://en.wikipedia.org/wiki/HTTP_persistent_connection">HTTP keep-alive connections</a> on a per-job basis. By default <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> uses keep-alive connections to scrape targets in order to reduce overhead on connection re-establishing.</li> </ul> <p>Note that <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> doesn't support <code class="language-plaintext highlighter-rouge notranslate">refresh_interval</code> option these scrape configs. Use the corresponding <code class="language-plaintext highlighter-rouge notranslate">-promscrape.*CheckInterval</code> command-line flag instead. For example, <code class="language-plaintext highlighter-rouge notranslate">-promscrape.consulSDCheckInterval=60s</code> sets <code class="language-plaintext highlighter-rouge notranslate">refresh_interval</code> for all the <code class="language-plaintext highlighter-rouge notranslate">consul_sd_configs</code> entries to 60s. Run <code class="language-plaintext highlighter-rouge notranslate">vmagent -help</code> in order to see default values for <code class="language-plaintext highlighter-rouge notranslate">-promscrape.*CheckInterval</code> flags.</p> <p>The file pointed by <code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code> may contain <code class="language-plaintext highlighter-rouge notranslate">%{ENV_VAR}</code> placeholders, which are substituted by the corresponding <code class="language-plaintext highlighter-rouge notranslate">ENV_VAR</code> environment variable values.</p> <h2 id="adding-labels-to-metrics">Adding labels to metrics</h2> <p>Labels can be added to metrics via the following mechanisms:</p> <ul> <li>Via <code class="language-plaintext highlighter-rouge notranslate">global -&gt; external_labels</code> section in <code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code> file. These labels are added only to metrics scraped from targets configured in <code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code> file.</li> <li>Via <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.label</code> command-line flag. These labels are added to all the collected metrics before sending them to <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code>.</li> </ul> <h2 id="relabeling">Relabeling</h2> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> supports <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config">Prometheus relabeling</a>. Additionally it provides the following extra actions:</p> <ul> <li><code class="language-plaintext highlighter-rouge notranslate">replace_all</code>: replaces all the occurences of <code class="language-plaintext highlighter-rouge notranslate">regex</code> in the values of <code class="language-plaintext highlighter-rouge notranslate">source_labels</code> with the <code class="language-plaintext highlighter-rouge notranslate">replacement</code> and stores the result in the <code class="language-plaintext highlighter-rouge notranslate">target_label</code>.</li> <li><code class="language-plaintext highlighter-rouge notranslate">labelmap_all</code>: replaces all the occurences of <code class="language-plaintext highlighter-rouge notranslate">regex</code> in all the label names with the <code class="language-plaintext highlighter-rouge notranslate">replacement</code>.</li> <li><code class="language-plaintext highlighter-rouge notranslate">keep_if_equal</code>: keeps the entry if all label values from <code class="language-plaintext highlighter-rouge notranslate">source_labels</code> are equal.</li> <li><code class="language-plaintext highlighter-rouge notranslate">drop_if_equal</code>: drops the entry if all the label values from <code class="language-plaintext highlighter-rouge notranslate">source_labels</code> are equal.</li> </ul> <p>The relabeling can be defined in the following places:</p> <ul> <li>At <code class="language-plaintext highlighter-rouge notranslate">scrape_config -&gt; relabel_configs</code> section in <code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code> file. This relabeling is applied to target labels.</li> <li>At <code class="language-plaintext highlighter-rouge notranslate">scrape_config -&gt; metric_relabel_configs</code> section in <code class="language-plaintext highlighter-rouge notranslate">-promscrape.config</code> file. This relabeling is applied to all the scraped metrics in the given <code class="language-plaintext highlighter-rouge notranslate">scrape_config</code>.</li> <li>At <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.relabelConfig</code> file. This relabeling is aplied to all the collected metrics before sending them to remote storage.</li> <li>At <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.urlRelabelConfig</code> files. This relabeling is applied to metrics before sending them to the corresponding <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code>.</li> </ul> <p>Read more about relabeling in the following articles:</p> <ul> <li><a href="https://valyala.medium.com/how-to-use-relabeling-in-prometheus-and-victoriametrics-8b90fc22c4b2">How to use Relabeling in Prometheus and VictoriaMetrics</a></li> <li><a href="https://www.robustperception.io/life-of-a-label">Life of a label</a></li> <li><a href="https://www.robustperception.io/relabelling-can-discard-targets-timeseries-and-alerts">Discarding targets and timeseries with relabeling</a></li> <li><a href="https://www.robustperception.io/dropping-metrics-at-scrape-time-with-prometheus">Dropping labels at scrape time</a></li> <li><a href="https://www.robustperception.io/extracting-labels-from-legacy-metric-names">Extracting labels from legacy metric names</a></li> <li><a href="https://www.robustperception.io/relabel_configs-vs-metric_relabel_configs">relabel_configs vs metric_relabel_configs</a></li> </ul> <h2 id="monitoring">Monitoring</h2> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> exports various metrics in Prometheus exposition format at <code class="language-plaintext highlighter-rouge notranslate">http://vmagent-host:8429/metrics</code> page. It is recommended setting up regular scraping of this page either via <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> itself or via Prometheus, so the exported metrics could be analyzed later. Use official <a href="https://grafana.com/grafana/dashboards/12683">Grafana dashboard</a> for <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> state overview. If you have suggestions, improvements or found a bug - feel free to open an issue on github or add review to the dashboard.</p> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> also exports target statuses at the following handlers:</p> <ul> <li><code class="language-plaintext highlighter-rouge notranslate">http://vmagent-host:8429/targets</code>. This handler returns human-readable plaintext status for every active target. This page is convenient to query from command line with <code class="language-plaintext highlighter-rouge notranslate">wget</code>, <code class="language-plaintext highlighter-rouge notranslate">curl</code> or similar tools. It accepts optional <code class="language-plaintext highlighter-rouge notranslate">show_original_labels=1</code> query arg, which shows the original labels per each target before applying relabeling. This information may be useful for debugging target relabeling.</li> <li> <p><code class="language-plaintext highlighter-rouge notranslate">http://vmagent-host:8429/api/v1/targets</code>. This handler returns data compatible with <a href="https://prometheus.io/docs/prometheus/latest/querying/api/#targets">the corresponding page from Prometheus API</a>.</p> </li> <li><code class="language-plaintext highlighter-rouge notranslate">http://vmagent-host:8429/ready</code>. This handler returns http 200 status code when <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> finishes initialization for all service_discovery configs. It may be useful for performing <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> rolling update without scrape loss.</li> </ul> <h2 id="troubleshooting">Troubleshooting</h2> <ul> <li> <p>It is recommended <a href="#monitoring">setting up the official Grafana dashboard</a> in order to monitor <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> state.</p> </li> <li> <p>It is recommended increasing the maximum number of open files in the system (<code class="language-plaintext highlighter-rouge notranslate">ulimit -n</code>) when scraping big number of targets, since <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> establishes at least a single TCP connection per each target.</p> </li> <li> <p>When <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> scrapes many unreliable targets, it can flood error log with scrape errors. These errors can be suppressed by passing <code class="language-plaintext highlighter-rouge notranslate">-promscrape.suppressScrapeErrors</code> command-line flag to <code class="language-plaintext highlighter-rouge notranslate">vmagent</code>. The most recent scrape error per each target can be observed at <code class="language-plaintext highlighter-rouge notranslate">http://vmagent-host:8429/targets</code> and <code class="language-plaintext highlighter-rouge notranslate">http://vmagent-host:8429/api/v1/targets</code>.</p> </li> <li> <p>The <code class="language-plaintext highlighter-rouge notranslate">/api/v1/targets</code> page could be useful for debugging relabeling process for scrape targets. This page contains original labels for targets dropped during relabeling (see "droppedTargets" section in the page output). By default up to <code class="language-plaintext highlighter-rouge notranslate">-promscrape.maxDroppedTargets</code> targets are shown here. If your setup drops more targets during relabeling, then increase <code class="language-plaintext highlighter-rouge notranslate">-promscrape.maxDroppedTargets</code> command-line flag value in order to see all the dropped targets. Note that tracking each dropped target requires up to 10Kb of RAM, so big values for <code class="language-plaintext highlighter-rouge notranslate">-promscrape.maxDroppedTargets</code> may result in increased memory usage if big number of scrape targets are dropped during relabeling.</p> </li> <li> <p>If <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> scrapes big number of targets, then <code class="language-plaintext highlighter-rouge notranslate">-promscrape.dropOriginalLabels</code> command-line option may be passed to <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> in order to reduce memory usage. This option drops <code class="language-plaintext highlighter-rouge notranslate">"discoveredLabels"</code> and <code class="language-plaintext highlighter-rouge notranslate">"droppedTargets"</code> lists at <code class="language-plaintext highlighter-rouge notranslate">/api/v1/targets</code> page, which may result in reduced debuggability for improperly configured per-target relabeling.</p> </li> <li> <p>If <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> scrapes targets with millions of metrics per each target (for instance, when scraping <a href="https://prometheus.io/docs/prometheus/latest/federation/">federation endpoints</a>), then it is recommended enabling <code class="language-plaintext highlighter-rouge notranslate">stream parsing mode</code> in order to reduce memory usage during scraping. This mode may be enabled either globally for all the scrape targets by passing <code class="language-plaintext highlighter-rouge notranslate">-promscrape.streamParse</code> command-line flag or on a per-scrape target basis with <code class="language-plaintext highlighter-rouge notranslate">stream_parse: true</code> option. For example:</p> <div class="language-yml highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="na">scrape_configs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">big-federate'</span>
  <span class="na">stream_parse</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">static_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">big-prometeus1</span>
    <span class="pi">-</span> <span class="s">big-prometeus2</span>
  <span class="na">honor_labels</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">metrics_path</span><span class="pi">:</span> <span class="s">/federate</span>
  <span class="na">params</span><span class="pi">:</span>
    <span class="s1">'</span><span class="s">match[]'</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">{__name__!=""}'</span><span class="pi">]</span>
</code></pre>  </div> </div> <p>Note that <code class="language-plaintext highlighter-rouge notranslate">sample_limit</code> option doesn't work if stream parsing is enabled, since the parsed data is pushed to remote storage as soon as it is parsed. So <code class="language-plaintext highlighter-rouge notranslate">sample_limit</code> option has no sense during stream parsing.</p> </li> <li> <p>It is recommended to increase <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.queues</code> if <code class="language-plaintext highlighter-rouge notranslate">vmagent_remotewrite_pending_data_bytes</code> metric exported at <code class="language-plaintext highlighter-rouge notranslate">http://vmagent-host:8429/metrics</code> page constantly grows.</p> </li> <li> <p>If you see gaps on the data pushed by <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> to remote storage when <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.maxDiskUsagePerURL</code> is set, then try increasing <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.queues</code>. Such gaps may appear because <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> cannot keep up with sending the collected data to remote storage, so it starts dropping the buffered data if the on-disk buffer size exceeds <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.maxDiskUsagePerURL</code>.</p> </li> <li> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> buffers scraped data at <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.tmpDataPath</code> directory until it is sent to <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code>. The directory can grow large when remote storage is unavailable for extended periods of time and if <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.maxDiskUsagePerURL</code> isn't set. If you don't want to send all the data from the directory to remote storage, simply stop <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> and delete the directory.</p> </li> <li> <p>By default <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> masks <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.url</code> with <code class="language-plaintext highlighter-rouge notranslate">secret-url</code> values in logs and at <code class="language-plaintext highlighter-rouge notranslate">/metrics</code> page because the url may contain sensitive information such as auth tokens or passwords. Pass <code class="language-plaintext highlighter-rouge notranslate">-remoteWrite.showURL</code> command-line flag when starting <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> in order to see all the valid urls.</p> </li> <li> <p>If scrapes must be aligned in time (for instance, if they must be performed at the beginning of every hour), then set <code class="language-plaintext highlighter-rouge notranslate">scrape_align_interval</code> option in the corresponding scrape config. For example, the following config aligns hourly scrapes to the nearest 10 minutes:</p> <div class="language-yml highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="na">scrape_configs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s">foo</span>
  <span class="na">scrape_interval</span><span class="pi">:</span> <span class="s">1h</span>
  <span class="na">scrape_align_interval</span><span class="pi">:</span> <span class="s">10m</span>
</code></pre>  </div> </div> </li> <li> <p>If you see <code class="language-plaintext highlighter-rouge notranslate">skipping duplicate scrape target with identical labels</code> errors when scraping Kubernetes pods, then it is likely these pods listen multiple ports or they use init container. These errors can be either fixed or suppressed with <code class="language-plaintext highlighter-rouge notranslate">-promscrape.suppressDuplicateScrapeTargetErrors</code> command-line flag. See available options below if you prefer fixing the root cause of the error:</p> <p>The following <code class="language-plaintext highlighter-rouge notranslate">relabel_configs</code> section may help determining <code class="language-plaintext highlighter-rouge notranslate">__meta_*</code> labels resulting in duplicate targets:</p> <div class="language-yml highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">action</span><span class="pi">:</span> <span class="s">labelmap</span>
  <span class="na">regex</span><span class="pi">:</span> <span class="s">__meta_(.*)</span>
</code></pre>  </div> </div> <p>The following relabeling rule may be added to <code class="language-plaintext highlighter-rouge notranslate">relabel_configs</code> section in order to filter out pods with unneeded ports:</p> <div class="language-yml highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">action</span><span class="pi">:</span> <span class="s">keep_if_equal</span>
  <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__meta_kubernetes_pod_annotation_prometheus_io_port</span><span class="pi">,</span> <span class="nv">__meta_kubernetes_pod_container_port_number</span><span class="pi">]</span>
</code></pre>  </div> </div> <p>The following relabeling rule may be added to <code class="language-plaintext highlighter-rouge notranslate">relabel_configs</code> section in order to filter out init container pods:</p> <div class="language-yml highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">action</span><span class="pi">:</span> <span class="s">drop</span>
  <span class="na">source_labels</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">__meta_kubernetes_pod_container_init</span><span class="pi">]</span>
  <span class="na">regex</span><span class="pi">:</span> <span class="no">true</span>
</code></pre>  </div> </div> </li> </ul> <h2 id="how-to-build-from-sources">How to build from sources</h2> <p>It is recommended using <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/releases">binary releases</a> - <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> is located in <code class="language-plaintext highlighter-rouge notranslate">vmutils-*</code> archives there.</p> <h3 id="development-build">Development build</h3> <ol> <li><a href="https://golang.org/doc/install">Install Go</a>. The minimum supported version is Go 1.13.</li> <li>Run <code class="language-plaintext highlighter-rouge notranslate">make vmagent</code> from the root folder of the repository. It builds <code class="language-plaintext highlighter-rouge notranslate">vmagent</code> binary and puts it into the <code class="language-plaintext highlighter-rouge notranslate">bin</code> folder.</li> </ol> <h3 id="production-build">Production build</h3> <ol> <li><a href="https://docs.docker.com/install/">Install docker</a>.</li> <li>Run <code class="language-plaintext highlighter-rouge notranslate">make vmagent-prod</code> from the root folder of the repository. It builds <code class="language-plaintext highlighter-rouge notranslate">vmagent-prod</code> binary and puts it into the <code class="language-plaintext highlighter-rouge notranslate">bin</code> folder.</li> </ol> <h3 id="building-docker-images">Building docker images</h3> <p>Run <code class="language-plaintext highlighter-rouge notranslate">make package-vmagent</code>. It builds <code class="language-plaintext highlighter-rouge notranslate">victoriametrics/vmagent:&lt;PKG_TAG&gt;</code> docker image locally. <code class="language-plaintext highlighter-rouge notranslate">&lt;PKG_TAG&gt;</code> is auto-generated image tag, which depends on source code in the repository. The <code class="language-plaintext highlighter-rouge notranslate">&lt;PKG_TAG&gt;</code> may be manually set via <code class="language-plaintext highlighter-rouge notranslate">PKG_TAG=foobar make package-vmagent</code>.</p> <p>The base docker image is <a href="https://hub.docker.com/_/alpine">alpine</a> but it is possible to use any other base image by setting it via <code class="language-plaintext highlighter-rouge notranslate">&lt;ROOT_IMAGE&gt;</code> environment variable. For example, the following command builds the image on top of <a href="https://hub.docker.com/_/scratch">scratch</a> image:</p> <div class="language-bash highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="nv">ROOT_IMAGE</span><span class="o">=</span>scratch make package-vmagent
</code></pre>  </div></div> <h3 id="arm-build">ARM build</h3> <p>ARM build may run on Raspberry Pi or on <a href="https://blog.cloudflare.com/arm-takes-wing/">energy-efficient ARM servers</a>.</p> <h3 id="development-arm-build">Development ARM build</h3> <ol> <li><a href="https://golang.org/doc/install">Install Go</a>. The minimum supported version is Go 1.13.</li> <li>Run <code class="language-plaintext highlighter-rouge notranslate">make vmagent-arm</code> or <code class="language-plaintext highlighter-rouge notranslate">make vmagent-arm64</code> from the root folder of the repository. It builds <code class="language-plaintext highlighter-rouge notranslate">vmagent-arm</code> or <code class="language-plaintext highlighter-rouge notranslate">vmagent-arm64</code> binary respectively and puts it into the <code class="language-plaintext highlighter-rouge notranslate">bin</code> folder.</li> </ol> <h3 id="production-arm-build">Production ARM build</h3> <ol> <li><a href="https://docs.docker.com/install/">Install docker</a>.</li> <li>Run <code class="language-plaintext highlighter-rouge notranslate">make vmagent-arm-prod</code> or <code class="language-plaintext highlighter-rouge notranslate">make vmagent-arm64-prod</code> from the root folder of the repository. It builds <code class="language-plaintext highlighter-rouge notranslate">vmagent-arm-prod</code> or <code class="language-plaintext highlighter-rouge notranslate">vmagent-arm64-prod</code> binary respectively and puts it into the <code class="language-plaintext highlighter-rouge notranslate">bin</code> folder.</li> </ol> <h2 id="profiling">Profiling</h2> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> provides handlers for collecting the following <a href="https://blog.golang.org/profiling-go-programs">Go profiles</a>:</p> <ul> <li>Memory profile. It can be collected with the following command:</li> </ul> <div class="language-bash highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> http://&lt;vmagent-host&gt;:8429/debug/pprof/heap <span class="o">&gt;</span> mem.pprof
</code></pre>  </div></div> <ul> <li>CPU profile. It can be collected with the following command:</li> </ul> <div class="language-bash highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> http://&lt;vmagent-host&gt;:8429/debug/pprof/profile <span class="o">&gt;</span> cpu.pprof
</code></pre>  </div></div> <p>The command for collecting CPU profile waits for 30 seconds before returning.</p> <p>The collected profiles may be analyzed with <a href="https://github.com/google/pprof">go tool pprof</a>.</p> <h2 id="advanced-usage">Advanced usage</h2> <p><code class="language-plaintext highlighter-rouge notranslate">vmagent</code> can be fine-tuned with various command-line flags. Run <code class="language-plaintext highlighter-rouge notranslate">./vmagent -help</code> in order to see the full list of these flags with their desciptions and default values:</p> <div class="language-plaintext highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>./vmagent -help

vmagent collects metrics data via popular data ingestion protocols and routes it to VictoriaMetrics.

See the docs at https://victoriametrics.github.io/vmagent.html .

  -csvTrimTimestamp duration
    	Trim timestamps when importing csv data to this duration. Minimum practical duration is 1ms. Higher duration (i.e. 1s) may be used for reducing disk space usage for timestamp data (default 1ms)
  -dryRun
    	Whether to check only config files without running vmagent. The following files are checked: -promscrape.config, -remoteWrite.relabelConfig, -remoteWrite.urlRelabelConfig . Unknown config entries are allowed in -promscrape.config by default. This can be changed with -promscrape.config.strictParse
  -enableTCP6
    	Whether to enable IPv6 for listening and dialing. By default only IPv4 TCP is used
  -envflag.enable
    	Whether to enable reading flags from environment variables additionally to command line. Command line flag values have priority over values from environment vars. Flags are read only from command line if this flag isn't set
  -envflag.prefix string
    	Prefix for environment variables if -envflag.enable is set
  -fs.disableMmap
    	Whether to use pread() instead of mmap() for reading data files. By default mmap() is used for 64-bit arches and pread() is used for 32-bit arches, since they cannot read data files bigger than 2^32 bytes in memory. mmap() is usually faster for reading small data chunks than pread()
  -graphiteListenAddr string
    	TCP and UDP address to listen for Graphite plaintext data. Usually :2003 must be set. Doesn't work if empty
  -graphiteTrimTimestamp duration
    	Trim timestamps for Graphite data to this duration. Minimum practical duration is 1s. Higher duration (i.e. 1m) may be used for reducing disk space usage for timestamp data (default 1s)
  -http.connTimeout duration
    	Incoming http connections are closed after the configured timeout. This may help spreading incoming load among a cluster of services behind load balancer. Note that the real timeout may be bigger by up to 10% as a protection from Thundering herd problem (default 2m0s)
  -http.disableResponseCompression
    	Disable compression of HTTP responses for saving CPU resources. By default compression is enabled to save network bandwidth
  -http.idleConnTimeout duration
    	Timeout for incoming idle http connections (default 1m0s)
  -http.maxGracefulShutdownDuration duration
    	The maximum duration for graceful shutdown of HTTP server. Highly loaded server may require increased value for graceful shutdown (default 7s)
  -http.pathPrefix string
    	An optional prefix to add to all the paths handled by http server. For example, if '-http.pathPrefix=/foo/bar' is set, then all the http requests will be handled on '/foo/bar/*' paths. This may be useful for proxied requests. See https://www.robustperception.io/using-external-urls-and-proxies-with-prometheus
  -http.shutdownDelay duration
    	Optional delay before http server shutdown. During this dealy the servier returns non-OK responses from /health page, so load balancers can route new requests to other servers
  -httpAuth.password string
    	Password for HTTP Basic Auth. The authentication is disabled if -httpAuth.username is empty
  -httpAuth.username string
    	Username for HTTP Basic Auth. The authentication is disabled if empty. See also -httpAuth.password
  -httpListenAddr string
    	TCP address to listen for http connections. Set this flag to empty value in order to disable listening on any port. This mode may be useful for running multiple vmagent instances on the same server. Note that /targets and /metrics pages aren't available if -httpListenAddr='' (default ":8429")
  -import.maxLineLen max_rows_per_line
    	The maximum length in bytes of a single line accepted by /api/v1/import; the line length can be limited with max_rows_per_line query arg passed to /api/v1/export
    	Supports the following optional suffixes for values: KB, MB, GB, KiB, MiB, GiB (default 104857600)
  -influx.maxLineSize value
    	The maximum size in bytes for a single Influx line during parsing
    	Supports the following optional suffixes for values: KB, MB, GB, KiB, MiB, GiB (default 262144)
  -influxListenAddr http://&lt;vmagent&gt;:8429/write
    	TCP and UDP address to listen for Influx line protocol data. Usually :8189 must be set. Doesn't work if empty. This flag isn't needed when ingesting data over HTTP - just send it to http://&lt;vmagent&gt;:8429/write
  -influxMeasurementFieldSeparator string
    	Separator for '{measurement}{separator}{field_name}' metric name when inserted via Influx line protocol (default "_")
  -influxSkipMeasurement
    	Uses '{field_name}' as a metric name while ignoring '{measurement}' and '-influxMeasurementFieldSeparator'
  -influxSkipSingleField
    	Uses '{measurement}' instead of '{measurement}{separator}{field_name}' for metic name if Influx line contains only a single field
  -influxTrimTimestamp duration
    	Trim timestamps for Influx line protocol data to this duration. Minimum practical duration is 1ms. Higher duration (i.e. 1s) may be used for reducing disk space usage for timestamp data (default 1ms)
  -insert.maxQueueDuration duration
    	The maximum duration for waiting in the queue for insert requests due to -maxConcurrentInserts (default 1m0s)
  -loggerDisableTimestamps
    	Whether to disable writing timestamps in logs
  -loggerErrorsPerSecondLimit int
    	Per-second limit on the number of ERROR messages. If more than the given number of errors are emitted per second, then the remaining errors are suppressed. Zero value disables the rate limit
  -loggerFormat string
    	Format for logs. Possible values: default, json (default "default")
  -loggerLevel string
    	Minimum level of errors to log. Possible values: INFO, WARN, ERROR, FATAL, PANIC (default "INFO")
  -loggerOutput string
    	Output for the logs. Supported values: stderr, stdout (default "stderr")
  -loggerTimezone string
    	Timezone to use for timestamps in logs. Local timezone can be used (default "UTC")
  -loggerWarnsPerSecondLimit int
    	Per-second limit on the number of WARN messages. If more than the given number of warns are emitted per second, then the remaining warns are suppressed. Zero value disables the rate limit
  -maxConcurrentInserts int
    	The maximum number of concurrent inserts. Default value should work for most cases, since it minimizes the overhead for concurrent inserts. This option is tigthly coupled with -insert.maxQueueDuration (default 16)
  -maxInsertRequestSize value
    	The maximum size in bytes of a single Prometheus remote_write API request
    	Supports the following optional suffixes for values: KB, MB, GB, KiB, MiB, GiB (default 33554432)
  -memory.allowedBytes value
    	Allowed size of system memory VictoriaMetrics caches may occupy. This option overrides -memory.allowedPercent if set to non-zero value. Too low value may increase cache miss rate, which usually results in higher CPU and disk IO usage. Too high value may evict too much data from OS page cache, which will result in higher disk IO usage
    	Supports the following optional suffixes for values: KB, MB, GB, KiB, MiB, GiB (default 0)
  -memory.allowedPercent float
    	Allowed percent of system memory VictoriaMetrics caches may occupy. See also -memory.allowedBytes. Too low value may increase cache miss rate, which usually results in higher CPU and disk IO usage. Too high value may evict too much data from OS page cache, which will result in higher disk IO usage (default 60)
  -metricsAuthKey string
    	Auth key for /metrics. It overrides httpAuth settings
  -opentsdbHTTPListenAddr string
    	TCP address to listen for OpentTSDB HTTP put requests. Usually :4242 must be set. Doesn't work if empty
  -opentsdbListenAddr string
    	TCP and UDP address to listen for OpentTSDB metrics. Telnet put messages and HTTP /api/put messages are simultaneously served on TCP port. Usually :4242 must be set. Doesn't work if empty
  -opentsdbTrimTimestamp duration
    	Trim timestamps for OpenTSDB 'telnet put' data to this duration. Minimum practical duration is 1s. Higher duration (i.e. 1m) may be used for reducing disk space usage for timestamp data (default 1s)
  -opentsdbhttp.maxInsertRequestSize value
    	The maximum size of OpenTSDB HTTP put request
    	Supports the following optional suffixes for values: KB, MB, GB, KiB, MiB, GiB (default 33554432)
  -opentsdbhttpTrimTimestamp duration
    	Trim timestamps for OpenTSDB HTTP data to this duration. Minimum practical duration is 1ms. Higher duration (i.e. 1s) may be used for reducing disk space usage for timestamp data (default 1ms)
  -pprofAuthKey string
    	Auth key for /debug/pprof. It overrides httpAuth settings
  -promscrape.config string
    	Optional path to Prometheus config file with 'scrape_configs' section containing targets to scrape. See https://victoriametrics.github.io/#how-to-scrape-prometheus-exporters-such-as-node-exporter for details
  -promscrape.config.dryRun
    	Checks -promscrape.config file for errors and unsupported fields and then exits. Returns non-zero exit code on parsing errors and emits these errors to stderr. See also -promscrape.config.strictParse command-line flag. Pass -loggerLevel=ERROR if you don't need to see info messages in the output.
  -promscrape.config.strictParse
    	Whether to allow only supported fields in -promscrape.config . By default unsupported fields are silently skipped
  -promscrape.configCheckInterval duration
    	Interval for checking for changes in '-promscrape.config' file. By default the checking is disabled. Send SIGHUP signal in order to force config check for changes
  -promscrape.consulSDCheckInterval consul_sd_configs
    	Interval for checking for changes in Consul. This works only if consul_sd_configs is configured in '-promscrape.config' file. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#consul_sd_config for details (default 30s)
  -promscrape.disableCompression
    	Whether to disable sending 'Accept-Encoding: gzip' request headers to all the scrape targets. This may reduce CPU usage on scrape targets at the cost of higher network bandwidth utilization. It is possible to set 'disable_compression: true' individually per each 'scrape_config' section in '-promscrape.config' for fine grained control
  -promscrape.disableKeepAlive disable_keepalive: true
    	Whether to disable HTTP keep-alive connections when scraping all the targets. This may be useful when targets has no support for HTTP keep-alive connection. It is possible to set disable_keepalive: true individually per each 'scrape_config` section in '-promscrape.config' for fine grained control. Note that disabling HTTP keep-alive may increase load on both vmagent and scrape targets
  -promscrape.discovery.concurrency int
    	The maximum number of concurrent requests to Prometheus autodiscovery API (Consul, Kubernetes, etc.) (default 100)
  -promscrape.discovery.concurrentWaitTime duration
    	The maximum duration for waiting to perform API requests if more than -promscrape.discovery.concurrency requests are simultaneously performed (default 1m0s)
  -promscrape.dnsSDCheckInterval dns_sd_configs
    	Interval for checking for changes in dns. This works only if dns_sd_configs is configured in '-promscrape.config' file. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dns_sd_config for details (default 30s)
  -promscrape.dockerswarmSDCheckInterval dockerswarm_sd_configs
    	Interval for checking for changes in dockerswarm. This works only if dockerswarm_sd_configs is configured in '-promscrape.config' file. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dockerswarm_sd_config for details (default 30s)
  -promscrape.dropOriginalLabels
    	Whether to drop original labels for scrape targets at /targets and /api/v1/targets pages. This may be needed for reducing memory usage when original labels for big number of scrape targets occupy big amounts of memory. Note that this reduces debuggability for improper per-target relabeling configs
  -promscrape.ec2SDCheckInterval ec2_sd_configs
    	Interval for checking for changes in ec2. This works only if ec2_sd_configs is configured in '-promscrape.config' file. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#ec2_sd_config for details (default 1m0s)
  -promscrape.eurekaSDCheckInterval eureka_sd_configs
    	Interval for checking for changes in eureka. This works only if eureka_sd_configs is configured in '-promscrape.config' file. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#eureka_sd_config for details (default 30s)
  -promscrape.fileSDCheckInterval duration
    	Interval for checking for changes in 'file_sd_config'. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#file_sd_config for details (default 30s)
  -promscrape.gceSDCheckInterval gce_sd_configs
    	Interval for checking for changes in gce. This works only if gce_sd_configs is configured in '-promscrape.config' file. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#gce_sd_config for details (default 1m0s)
  -promscrape.kubernetesSDCheckInterval kubernetes_sd_configs
    	Interval for checking for changes in Kubernetes API server. This works only if kubernetes_sd_configs is configured in '-promscrape.config' file. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config for details (default 30s)
  -promscrape.maxDroppedTargets droppedTargets
    	The maximum number of droppedTargets shown at /api/v1/targets page. Increase this value if your setup drops more scrape targets during relabeling and you need investigating labels for all the dropped targets. Note that the increased number of tracked dropped targets may result in increased memory usage (default 1000)
  -promscrape.maxScrapeSize value
    	The maximum size of scrape response in bytes to process from Prometheus targets. Bigger responses are rejected
    	Supports the following optional suffixes for values: KB, MB, GB, KiB, MiB, GiB (default 16777216)
  -promscrape.openstackSDCheckInterval openstack_sd_configs
    	Interval for checking for changes in openstack API server. This works only if openstack_sd_configs is configured in '-promscrape.config' file. See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#openstack_sd_config for details (default 30s)
  -promscrape.streamParse stream_parse: true
    	Whether to enable stream parsing for metrics obtained from scrape targets. This may be useful for reducing memory usage when millions of metrics are exposed per each scrape target. It is posible to set stream_parse: true individually per each `scrape_config` section in `-promscrape.config` for fine grained control
  -promscrape.suppressDuplicateScrapeTargetErrors duplicate scrape target
    	Whether to suppress duplicate scrape target errors; see https://victoriametrics.github.io/vmagent.html#troubleshooting for details
  -promscrape.suppressScrapeErrors
    	Whether to suppress scrape errors logging. The last error for each target is always available at '/targets' page even if scrape errors logging is suppressed
  -remoteWrite.basicAuth.password array
    	Optional basic auth password to use for -remoteWrite.url. If multiple args are set, then they are applied independently for the corresponding -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.basicAuth.username array
    	Optional basic auth username to use for -remoteWrite.url. If multiple args are set, then they are applied independently for the corresponding -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.bearerToken array
    	Optional bearer auth token to use for -remoteWrite.url. If multiple args are set, then they are applied independently for the corresponding -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.flushInterval duration
    	Interval for flushing the data to remote storage. Higher value reduces network bandwidth usage at the cost of delayed push of scraped data to remote storage. Minimum supported interval is 1 second (default 1s)
  -remoteWrite.label array
    	Optional label in the form 'name=value' to add to all the metrics before sending them to -remoteWrite.url. Pass multiple -remoteWrite.label flags in order to add multiple flags to metrics before sending them to remote storage
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.maxBlockSize value
    	The maximum size in bytes of unpacked request to send to remote storage. It shouldn't exceed -maxInsertRequestSize from VictoriaMetrics
    	Supports the following optional suffixes for values: KB, MB, GB, KiB, MiB, GiB (default 8388608)
  -remoteWrite.maxDiskUsagePerURL value
    	The maximum file-based buffer size in bytes at -remoteWrite.tmpDataPath for each -remoteWrite.url. When buffer size reaches the configured maximum, then old data is dropped when adding new data to the buffer. Buffered data is stored in ~500MB chunks, so the minimum practical value for this flag is 500000000. Disk usage is unlimited if the value is set to 0
    	Supports the following optional suffixes for values: KB, MB, GB, KiB, MiB, GiB (default 0)
  -remoteWrite.proxyURL array
    	Optional proxy URL for writing data to -remoteWrite.url. Supported proxies: http, https, socks5. Example: -remoteWrite.proxyURL=socks5://proxy:1234
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.queues int
    	The number of concurrent queues to each -remoteWrite.url. Set more queues if default number of queues isn't enough for sending high volume of collected data to remote storage (default 4)
  -remoteWrite.rateLimit array
    	Optional rate limit in bytes per second for data sent to -remoteWrite.url. By default the rate limit is disabled. It can be useful for limiting load on remote storage when big amounts of buffered data is sent after temporary unavailability of the remote storage
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.relabelConfig string
    	Optional path to file with relabel_config entries. These entries are applied to all the metrics before sending them to -remoteWrite.url. See https://victoriametrics.github.io/vmagent.html#relabeling for details
  -remoteWrite.roundDigits array
    	Round metric values to this number of decimal digits after the point before writing them to remote storage. Examples: -remoteWrite.roundDigits=2 would round 1.236 to 1.24, while -remoteWrite.roundDigits=-1 would round 126.78 to 130. By default digits rounding is disabled. Set it to 100 for disabling it for a particular remote storage. This option may be used for improving data compression for the stored metrics
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.sendTimeout array
    	Timeout for sending a single block of data to -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.showURL
    	Whether to show -remoteWrite.url in the exported metrics. It is hidden by default, since it can contain sensitive info such as auth key
  -remoteWrite.significantFigures array
    	The number of significant figures to leave in metric values before writing them to remote storage. See https://en.wikipedia.org/wiki/Significant_figures . Zero value saves all the significant figures. This option may be used for improving data compression for the stored metrics. See also -remoteWrite.roundDigits
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.tlsCAFile array
    	Optional path to TLS CA file to use for verifying connections to -remoteWrite.url. By default system CA is used. If multiple args are set, then they are applied independently for the corresponding -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.tlsCertFile array
    	Optional path to client-side TLS certificate file to use when connecting to -remoteWrite.url. If multiple args are set, then they are applied independently for the corresponding -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.tlsInsecureSkipVerify array
    	Whether to skip tls verification when connecting to -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.tlsKeyFile array
    	Optional path to client-side TLS certificate key to use when connecting to -remoteWrite.url. If multiple args are set, then they are applied independently for the corresponding -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.tlsServerName array
    	Optional TLS server name to use for connections to -remoteWrite.url. By default the server name from -remoteWrite.url is used. If multiple args are set, then they are applied independently for the corresponding -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.tmpDataPath string
    	Path to directory where temporary data for remote write component is stored (default "vmagent-remotewrite-data")
  -remoteWrite.url array
    	Remote storage URL to write data to. It must support Prometheus remote_write API. It is recommended using VictoriaMetrics as remote storage. Example url: http://&lt;victoriametrics-host&gt;:8428/api/v1/write . Pass multiple -remoteWrite.url flags in order to write data concurrently to multiple remote storage systems
    	Supports array of values separated by comma or specified via multiple flags.
  -remoteWrite.urlRelabelConfig array
    	Optional path to relabel config for the corresponding -remoteWrite.url
    	Supports array of values separated by comma or specified via multiple flags.
  -tls
    	Whether to enable TLS (aka HTTPS) for incoming requests. -tlsCertFile and -tlsKeyFile must be set if -tls is set
  -tlsCertFile string
    	Path to file with TLS certificate. Used only if -tls is set. Prefer ECDSA certs instead of RSA certs, since RSA certs are slow
  -tlsKeyFile string
    	Path to file with TLS key. Used only if -tls is set
  -version
    	Show VictoriaMetrics version
</code></pre>  </div></div> </div> </div> <div class="navigation-bottom d-flex flex-justify-between py-3" role="navigation" aria-label="footer navigation"> <div class="prev"><a href="/Single-server-VictoriaMetrics.html" class="btn" title="" accesskey="p" rel="prev"> <i class="fa fa-arrow-circle-left"></i> Previous </a></div> <div class="next"><a href="/vmalert.html" class="btn" title="vmalert" accesskey="n" rel="next"> Next <i class="fa fa-arrow-circle-right"></i> </a></div> </div><hr> <div class="copyright text-center text-gray" role="contentinfo"> <i class="fa fa-copyright"></i> <span class="time">2021,</span> <a class="text-gray" href="https://github.com/Brensted" rel="noreferrer" target="_blank">Brensted</a> Revision <a class="text-gray" href="https://github.com/Brensted/test1/commit/156072bda364bc719a657b8c14a5f5ba4c757132" title="156072bda364bc719a657b8c14a5f5ba4c757132" rel="noreferrer" target="_blank">156072b</a> <br> <div class="generator"> Built with <a href="https://pages.github.com" rel="noreferrer" target="_blank" title="github-pages v209">GitHub Pages</a> using a <a href="https://github.com/rundocs/jekyll-rtd-theme" rel="noreferrer" target="_blank" title="rundocs/jekyll-rtd-theme v2.0.10">theme</a> provided by <a href="https://rundocs.io" rel="noreferrer" target="_blank">RunDocs</a>. </div> </div> </div> </div> <div class="addons-wrap d-flex flex-column overflow-y-auto"> <div class="status d-flex flex-justify-between p-2"> <div class="title p-1"> <i class="fa fa-book"></i> VictoriaMetrics </div> <div class="branch p-1"> <span class="name"> gh-pages </span> <i class="fa fa-caret-down"></i> </div> </div> <div class="addons d-flex flex-column height-full p-2 d-none"> <dl> <dt>GitHub</dt> <dd> <a href="https://github.com/Brensted/test1" title="Stars: 0"> <i class="fa fa-github"></i> Homepage </a> </dd> <dd> <a href="https://github.com/Brensted/test1/issues" title="Open issues: 0"> <i class="fa fa-question-circle-o"></i> Issues </a> </dd> <dd> <a href="https://github.com/Brensted/test1/zipball/gh-pages" title="Size: 0 Kb"> <i class="fa fa-download"></i> Download </a> </dd> </dl> <hr> <div class="license f6 pb-2"> This <a href="/" title="VictoriaMetrics">Software</a> is under the terms of <a href="https://github.com/Brensted/test1">The Unlicense</a>. </div> </div> </div> <script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/theme.min.js"></script> </body> </html>